# Story 1.4: Agent Protocol Parser (Backend)

## Status
Done

## Executor Assignment
executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: [lint, typecheck, test]

## Story
**As a** backend developer,
**I want** to implement a parser that extracts agent name, status, tasks, and messages from structured output strings,
**so that** I can transform raw terminal outputs into structured data that the frontend can render visually.

## Acceptance Criteria
1. Parser module created at `backend/src/parser/agent-parser.ts`
2. Parser extracts data from protocol format: `[AGENT:Name][STATUS:state] message [TASKS]...[/TASKS] [OUTPUT:file]...[/OUTPUT] [HANDOFF:Next]`
3. Parser returns TypeScript object: `{ agent, status, message, tasks[], output, handoff }`
4. Parser handles missing sections gracefully (returns null/undefined for missing fields)
5. Parser has fallback mode: if no `[AGENT:...]` tag found, returns `{ agent: 'unknown', message: rawText }`
6. Unit tests with Jest covering: valid parsing, missing sections, malformed input, empty strings, long messages (10,000+ chars)
7. Test coverage >= 90% for parser module
8. Parser logs warnings for malformed inputs using Winston
9. TypeScript types exported to `shared/types.ts`: `ParsedAgentMessage`, `Task`
10. Parser exports function: `parseAgentOutput(raw: string): ParsedAgentMessage`

## ðŸ¤– CodeRabbit Integration

### Story Type Analysis
**Primary Type**: API/Backend
**Secondary Type(s)**: None
**Complexity**: Medium

### Specialized Agent Assignment
**Primary Agents**:
- @dev: Implementation and testing

### Quality Gate Tasks
- [ ] Pre-Commit (@dev): Run before marking story complete

### CodeRabbit Focus Areas
**Primary Focus**:
- Error handling: Graceful fallback for malformed input
- Performance: Regex efficiency for 10,000+ char strings
- Test coverage: 90%+ required

## Tasks / Subtasks

- [x] Task 1: Create parser module (AC: 1, 2, 3, 10)
  - [x] Create `backend/src/parser/agent-parser.ts`
  - [x] Implement regex patterns: AGENT_REGEX, TASKS_REGEX, OUTPUT_REGEX, HANDOFF_REGEX, TASK_LINE_REGEX
  - [x] Implement `parseAgentOutput(raw: string): ParsedAgentMessage`
  - [x] Extract: agent, status, message, tasks[], output, handoff
- [x] Task 2: Handle edge cases (AC: 4, 5)
  - [x] Missing [TASKS] block â†’ tasks = []
  - [x] Missing [OUTPUT] block â†’ output = null
  - [x] Missing [HANDOFF] block â†’ handoff = null
  - [x] No [AGENT:] tag â†’ agent = 'unknown', message = rawText
  - [x] Empty string â†’ agent = 'unknown', message = ''
- [x] Task 3: Add logging for malformed inputs (AC: 8)
  - [x] Import Winston logger
  - [x] Log warning when no [AGENT:] tag found
  - [x] Log warning when empty input received
- [x] Task 4: Ensure shared types exist (AC: 9)
  - [x] Verify `ParsedAgentMessage` and `Task` types in `shared/types.ts` (pre-existing from Story 1.1)
  - [x] Import types from shared package in parser
- [x] Task 5: Write comprehensive unit tests (AC: 6, 7)
  - [x] Test: valid full protocol message (all sections present)
  - [x] Test: message with only AGENT+STATUS (no TASKS/OUTPUT/HANDOFF)
  - [x] Test: message with TASKS but no OUTPUT
  - [x] Test: malformed input (random text, no tags)
  - [x] Test: empty string
  - [x] Test: very long message (10,000+ chars)
  - [x] Test: multiple [x], [~], [ ] task markers
  - [x] Test: special characters in message text
  - [x] Verify coverage >= 90% (100% Stmts, 92.85% Branch)

## Dev Notes

### Architecture Reference
From `system-architecture.md` Section 4.2 â€” complete parser implementation:

```typescript
const AGENT_REGEX = /\[AGENT:(\w+)\]\[STATUS:(\w+)\]/;
const TASKS_REGEX = /\[TASKS\]([\s\S]*?)\[\/TASKS\]/;
const OUTPUT_REGEX = /\[OUTPUT:([^\]]+)\]([\s\S]*?)\[\/OUTPUT\]/;
const HANDOFF_REGEX = /\[HANDOFF:(\w+)\]([\s\S]*?)\[\/HANDOFF\]/;
const TASK_LINE_REGEX = /^-\s*\[([ x~])\]\s*(.+)$/gm;
```

**Protocol format** from Section 4.1:
```
[AGENT:{AgentName}][STATUS:{status}]
{Message content}
[TASKS]
- [x] Completed task
- [~] In progress task
- [ ] Pending task
[/TASKS]
[OUTPUT:{filename}]
{Artifact content}
[/OUTPUT]
[HANDOFF:{NextAgentName}]
{Context}
[/HANDOFF]
```

**Task status mapping:** `x` â†’ completed, `~` â†’ in_progress, ` ` â†’ pending

### Types (from shared/types.ts)
```typescript
interface ParsedAgentMessage {
  agent: AgentId | 'unknown';
  status: AgentStatus;
  message: string;
  tasks: Task[];
  output: { filename: string; content: string } | null;
  handoff: AgentId | null;
}

interface Task {
  text: string;
  status: 'pending' | 'in_progress' | 'completed';
}
```

### Testing
- Test location: `backend/tests/parser.test.ts`
- Framework: Jest + ts-jest
- Coverage target: >= 90% for parser module
- Use `--coverage` flag to verify

### Dependency
- **Depends on:** Story 1.1 (shared types), Story 1.2 (Winston logger)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 1.0 | Story created from PRD Epic 1 | River (SM) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (@dev / Dex)

### Debug Log References
- 14/14 tests passing (3 suites: parser, socket, health)
- Coverage: 100% Stmts, 92.85% Branch, 100% Funcs, 100% Lines

### Completion Notes List
- Parser uses regex from architecture Section 4.2
- Fallback mode for untagged input returns agent='unknown'
- Winston warns on empty/malformed inputs
- Types imported from shared/types.ts (pre-existing)

### File List
- `backend/src/parser/agent-parser.ts` â€” Parser module (new)
- `backend/tests/parser.test.ts` â€” 10 test cases (new)

## QA Results
(to be filled by QA agent)
