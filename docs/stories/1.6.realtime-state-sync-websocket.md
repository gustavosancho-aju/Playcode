# Story 1.6: Real-time State Sync via WebSocket

## Status
InProgress

## Executor Assignment
executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: [lint, typecheck, test]

## Story
**As a** user,
**I want** agent houses to update their status in real-time when the backend sends WebSocket messages,
**so that** I can see live feedback as the pipeline progresses without refreshing the page.

## Acceptance Criteria
1. Backend mock endpoint: `POST /api/mock/agent-update` accepts `{ agent, status, message }`
2. Endpoint broadcasts message via WebSocket to all connected clients
3. Frontend listener updates Zustand store on `agent-update` event
4. AgentHouse component reacts: status indicator changes, border glows, message appears on hover
5. Latency from endpoint call to UI update < 500ms
6. Multiple rapid updates (5+/sec) don't cause UI jank
7. Frontend handles WebSocket reconnection within 3 seconds
8. Test script: `scripts/test-websocket.js` sends 8 sequential mock updates
9. Running test script shows all 8 houses lighting up sequentially
10. Reconnection counter displayed when connection drops

## ðŸ¤– CodeRabbit Integration

### Story Type Analysis
**Primary Type**: Integration
**Secondary Type(s)**: Frontend, API
**Complexity**: Medium

### Specialized Agent Assignment
**Primary Agents**:
- @dev: Full-stack implementation

### Quality Gate Tasks
- [ ] Pre-Commit (@dev): Run before marking story complete

### CodeRabbit Focus Areas
**Primary Focus**:
- WebSocket: Reconnection logic, event handling
- Performance: No UI jank on rapid updates
- Error handling: Graceful reconnection

## Tasks / Subtasks

- [x] Task 1: Backend mock endpoint (AC: 1, 2)
  - [x] Create `backend/src/routes/mock.ts`
  - [x] POST `/api/mock/agent-update` â€” validates body { agent, status, message }
  - [x] Broadcasts via Socket.io `pipeline-update` event to all clients
  - [x] Register route in express app
- [x] Task 2: Frontend WebSocket listener (AC: 3)
  - [x] Update `useSocket.ts` hook to listen for `pipeline-update` events
  - [x] On event: call `useAgentStore.getState().updateAgent(id, patch)`
  - [x] Handle status and message updates
- [x] Task 3: AgentHouse reactive updates (AC: 4)
  - [x] AgentHouse reacts to status changes via Zustand store
  - [x] On status change: border glows, status badge updates, opacity changes
  - [x] On message: shows truncated message text
  - [x] CSS transitions on border color, opacity, glow
- [x] Task 4: Reconnection handling (AC: 7, 10)
  - [x] Socket.io auto-reconnect config (maxRetries: 10, delay: 1000ms)
  - [x] Update `useConnectionStore` with reconnectAttempts count
  - [x] Show reconnection counter in ConnectionStatus component
  - [x] Reset counter on successful reconnect
- [x] Task 5: Test script (AC: 8, 9)
  - [x] Create `scripts/test-websocket.js`
  - [x] Script sends 8 POST requests to `/api/mock/agent-update` sequentially
  - [x] 2-second delay between each update
  - [x] Each update: processing then done per agent
  - [x] Console output showing progress
- [x] Task 6: Performance validation (AC: 5, 6)
  - [x] Zustand selector optimization: useAgentStore.getState() for external updates
  - [x] AgentHouse receives individual agent prop (no full array re-render)

## Dev Notes

### Architecture Reference
From `system-architecture.md` Section 3.4 â€” Mock API:
```yaml
POST /api/mock/agent-update â†’ { broadcasted: true }
     Body: { agent, status, message }
```

From Section 3.5 â€” Socket.io events:
```yaml
pipeline-update:
  agent: AgentId
  status: 'processing' | 'done'
  step: number
  totalSteps: 7
  message?: string
  artifactPath?: string
```

From Section 2.1 â€” Communication between layers:
```typescript
// WebSocket events update Zustand store (bridge)
socket.on('pipeline-update', (data) => {
  useAgentStore.getState().updateAgent(data);
});
```

**Zustand selector optimization** â€” each AgentHouse should use:
```typescript
const agent = useAgentStore(s => s.agents.find(a => a.id === agentId));
```
NOT `useAgentStore(s => s.agents)` which would re-render all houses on any change.

### Test Script Usage
```bash
node scripts/test-websocket.js
# Sends: masterâ†’processing, masterâ†’done, pesquisaâ†’processing, pesquisaâ†’done, ...
```

### Testing
- Integration test: mock endpoint broadcasts correctly
- Manual test: run test script, watch houses update in browser
- Performance: Chrome DevTools Performance tab during rapid updates

### Dependency
- **Depends on:** Story 1.2 (WebSocket server), Story 1.3 (WebSocket client), Story 1.5 (Dashboard + houses)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 1.0 | Story created from PRD Epic 1 | River (SM) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (@dev / Dex)

### Debug Log References
- TypeScript: 0 errors (backend + frontend)
- Tests: 14/14 passing (3 suites)

### Completion Notes List
- Mock endpoint validates body and broadcasts via Socket.io
- useSocket hook listens for pipeline-update and updates Zustand store
- ConnectionStatus shows reconnection counter when disconnected
- Test script sends sequential processingâ†’done for all 8 agents

### File List
- `backend/src/routes/mock.ts` â€” Mock agent-update endpoint (new)
- `backend/src/index.ts` â€” Registers mock router with io instance
- `frontend/src/hooks/useSocket.ts` â€” Added pipeline-update listener + reconnection config
- `frontend/src/components/ConnectionStatus.tsx` â€” Added reconnection counter
- `scripts/test-websocket.js` â€” 8-agent sequential test script (new)

## QA Results
(to be filled by QA agent)
