# Story 4.1: Approval Popup & Flow Control

## Status
Done

## Executor Assignment
executor: "@dev"
quality_gate: "@qa"
quality_gate_tools: [lint, typecheck, manual-test]

## Story
**As a** consultant,
**I want** an approval popup at critical pipeline steps with options to approve, edit, or go back,
**so that** I maintain control over deliverable quality.

## Acceptance Criteria
1. `ApprovalPopup.tsx` as modal overlay
2. Triggered by `approval-required` WebSocket event
3. Shows: agent name/icon, artifact preview (rendered Markdown), three buttons
4. Approve: sends approve event, closes popup, Neo resumes
5. Edit: opens inline editor with artifact pre-loaded
6. Back: sends rollback event, pipeline re-runs previous agent
7. Neo plays processing animation while popup visible
8. Timer pauses while popup open
9. Dark backdrop (click outside doesn't dismiss)
10. Keyboard: Enter=Approve, E=Edit, Escape=keep paused
11. Matrix theme: dark background, green borders

## Traceability
- FR28: Popup de aprovacao com [Aprovar] [Editar] [Voltar]
- FR29: Editar artefato inline antes de aprovar
- FR30: Modo hibrido com etapas automaticas vs aprovacao manual

## Tasks / Subtasks

- [x] Task 1: Create ApprovalPopup component (AC: 1, 3, 9, 11)
  - [x] Create `frontend/src/components/ApprovalPopup.tsx`
  - [x] Modal overlay with dark backdrop (no dismiss on outside click)
  - [x] Display agent name, icon, and color from AGENT_DEFINITIONS
  - [x] Render artifact Markdown preview (pre block with truncation at 2000 chars)
  - [x] Matrix theme: black bg, green borders, monospace font
- [x] Task 2: Implement approval flow buttons (AC: 4, 5, 6)
  - [x] Approve button: emit `pipeline:approve` via WebSocket, close popup
  - [x] Edit button: stub for Story 4.2 (logs to console)
  - [x] Back button: emit `pipeline:rollback` via WebSocket, close popup
- [x] Task 3: WebSocket integration (AC: 2)
  - [x] Listen for `approval-required` event in usePipelineStore
  - [x] Store pending approval data: agentId, artifactContent, artifactName
  - [x] Show popup when approval data is present
- [x] Task 4: Game state sync (AC: 7, 8)
  - [x] Pause timer in useGameStore when popup visible
  - [x] PipelineScene already handles `approval_required` status for Neo processing animation
  - [x] Resume timer on approve/back
- [x] Task 5: Keyboard shortcuts (AC: 10)
  - [x] Enter = Approve
  - [x] E = Edit
  - [x] Escape = keep paused (no action)
  - [x] Only active when popup is visible
- [x] Task 6: Integration in App.tsx
  - [x] Add ApprovalPopup to App component
  - [x] Conditionally render based on pipeline approval state

## Dev Notes

### Architecture Reference
- Backend already emits `approval-required` events (Story 2.3 orchestrator)
- Pipeline orchestrator pauses on `approvalRequired[agentId]` config
- Artifact content available via `GET /api/artifacts/{sessionId}/{filename}`

### Dependencies
- Story 2.3 (Pipeline Orchestrator) — provides approval events
- Story 4.2 (Inline Editor) — Edit button integration (can stub initially)
- Story 4.3 (Rollback) — Back button integration (can stub initially)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 1.0 | Story created from PRD Epic 4 | River (SM) |

## QA Results
(to be filled by QA agent)
