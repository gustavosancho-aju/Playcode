# Story 4.3: Pipeline Rollback & Retry

## Status
Done

## Executor Assignment
executor: "@dev"
quality_gate: "@qa"
quality_gate_tools: [lint, typecheck, manual-test]

## Story
**As a** consultant,
**I want** to go back to a previous pipeline step and re-run an agent,
**so that** I can fix issues without restarting the entire pipeline.

## Acceptance Criteria
1. Backend rollback handler: resets pipeline state to target step
2. Preserves artifacts from steps BEFORE target
3. Marks target and subsequent steps as pending
4. Frontend: rolled-back houses return to waiting status
5. Neo walks backward to target house
6. Re-executes agent with original or edited input
7. Edited artifacts used as input if modified before rollback
8. No rollback depth limit
9. Rollback logged in pipeline state
10. HUD updates (stars decrease on rollback)

## Traceability
- FR31: Pausar pipeline a qualquer momento e retomar
- FR32: Voltar para etapa anterior e reprocessar com ajustes

## Tasks / Subtasks

- [x] Task 1: Backend rollback handler (AC: 1, 2, 3, 9)
  - [ ] Add `rollbackPipeline(sessionId, targetStep)` to orchestrator
  - [ ] Reset pipeline state: mark target + subsequent steps as `pending`
  - [ ] Preserve artifacts from steps before target (don't delete)
  - [ ] Log rollback event in `pipeline-state.json`
  - [ ] WebSocket endpoint: `pipeline:rollback` with `{ sessionId, targetStep }`
- [x] Task 2: Frontend state handling (AC: 4, 10)
  - [ ] Handle `pipeline-rollback` WebSocket event in usePipelineStore
  - [ ] Reset agent statuses for rolled-back steps to `waiting`
  - [ ] Update useGameStore: decrease stagesCompleted and artifactsCollected
- [x] Task 3: Neo backward movement (AC: 5)
  - [ ] PipelineScene: detect rollback, move Neo to target house
  - [ ] Neo walks backward (flipX) to target house
- [x] Task 4: Re-execution with edited input (AC: 6, 7, 8)
  - [ ] On rollback, re-execute agent from target step
  - [ ] If artifact was edited (via Story 4.2), use edited version as input
  - [ ] No depth limit: can rollback to step 1 from step 7
- [x] Task 5: Integration with ApprovalPopup
  - [ ] Back button in ApprovalPopup triggers rollback to previous step
  - [ ] Confirm dialog: "Voltar para {agentName}?"

## Dev Notes

### Architecture Reference
- Orchestrator at `backend/src/pipeline/orchestrator.ts`
- Pipeline state at `docs/artifacts/{sessionId}/pipeline-state.json`
- Each step feeds output to next step as input

### Dependencies
- Story 2.3 (Pipeline Orchestrator) — base orchestrator to extend
- Story 4.1 (Approval Popup) — Back button triggers rollback

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 1.0 | Story created from PRD Epic 4 | River (SM) |

## QA Results
(to be filled by QA agent)
