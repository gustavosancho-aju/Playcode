# Story 4.7: Error Handling & Loading States

## Status
Done

## Executor Assignment
executor: "@dev"
quality_gate: "@qa"
quality_gate_tools: [lint, typecheck, manual-test]

## Story
**As a** user,
**I want** graceful error handling with informative messages and loading states,
**so that** I never feel lost about what's happening.

## Acceptance Criteria
1. Toast system: success (green), error (red), warning (yellow), info (blue), auto-dismiss 5s
2. WebSocket disconnect: persistent reconnecting banner
3. Agent error: toast with retry countdown
4. Retry fail: popup with [Retry] [Skip] [Stop]
5. Loading states: house spinner, editor "Saving...", download progress bar
6. Skeleton loaders for initial load
7. Empty state: "Start a new mission" CTA
8. 404: "Artifact not yet generated" message
9. All error messages in Portuguese (pt-BR)
10. Error logs in `backend/logs/error.log`

## Traceability
- NFR7: Fallback para mensagens fora do protocolo
- NFR9: Logs detalhados com Winston (error, warn, info, debug)
- NFR10: Recuperar gracefully de erros sem crashar interface

## Tasks / Subtasks

- [x] Task 1: Toast notification system (AC: 1, 9)
  - [ ] Create `frontend/src/components/ToastSystem.tsx`
  - [ ] 4 types: success (green), error (red), warning (yellow), info (blue)
  - [ ] Auto-dismiss after 5 seconds
  - [ ] Stack multiple toasts vertically
  - [ ] All messages in pt-BR
  - [ ] Create `useToastStore.ts` in Zustand
- [x] Task 2: WebSocket reconnection UI (AC: 2)
  - [ ] Persistent banner at top when disconnected: "Reconectando..."
  - [ ] Show reconnection attempt count
  - [ ] Auto-dismiss on successful reconnection
  - [ ] Enhance existing ErrorToast or create ReconnectBanner
- [x] Task 3: Agent error handling (AC: 3, 4)
  - [ ] On agent error: show toast with retry countdown (10s)
  - [ ] Auto-retry once after countdown
  - [ ] On retry fail: popup with [Retry] [Skip Agent] [Stop Pipeline]
  - [ ] Skip: mark agent as skipped, continue pipeline
  - [ ] Stop: pause pipeline, return to idle
- [x] Task 4: Loading states (AC: 5, 6, 7)
  - [ ] House spinner: rotating icon when agent processing
  - [ ] Editor: "Salvando..." indicator during save
  - [ ] Download: progress bar during ZIP generation
  - [ ] Skeleton loaders on initial dashboard load
  - [ ] Empty state: "Iniciar nova missao" CTA when no pipeline active
- [x] Task 5: 404 and missing artifacts (AC: 8)
  - [ ] API returns 404 with `{ message: "Artefato ainda nao gerado" }` for missing files
  - [ ] Frontend handles 404 gracefully with user-friendly message
- [x] Task 6: Backend error logging (AC: 10)
  - [ ] Configure Winston file transport: `backend/logs/error.log`
  - [ ] Log all errors with stack traces
  - [ ] Log agent failures with context (agentId, sessionId, step)

## Dev Notes

### Architecture Reference
- Existing ErrorToast at `frontend/src/components/ErrorToast.tsx`
- Winston already configured in backend (Story 1.2)
- WebSocket reconnection logic in `useSocket.ts`

### Dependencies
- Story 1.2 (Backend WebSocket) — Winston logging base
- Story 1.3 (Frontend WebSocket) — reconnection base
- Story 2.3 (Pipeline Orchestrator) — error events

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 1.0 | Story created from PRD Epic 4 | River (SM) |

## QA Results
(to be filled by QA agent)
