# Story 4.8: Performance Optimization & Session Stability

## Status
Done

## Executor Assignment
executor: "@dev"
quality_gate: "@qa"
quality_gate_tools: [lint, typecheck, performance-audit]

## Story
**As a** consultant,
**I want** stable 2+ hour sessions without memory leaks or degradation,
**so that** I can use the system for real work.

## Acceptance Criteria
1. Heap growth < 50MB over 2 hours (Chrome DevTools)
2. WebSocket heartbeat every 30s, auto-reconnect within 5s
3. Phaser: no orphaned sprites/particles/tweens after pipeline
4. React: no state updates on unmounted components
5. Code rain: max 40 columns, object pool pattern
6. Artifact streaming for large files
7. WebSocket: max 10 updates/sec (batched)
8. Frontend bundle < 500KB gzipped
9. Lighthouse: Performance > 85, Accessibility > 90
10. 3 consecutive pipelines without degradation

## Traceability
- NFR1: Latencia < 500ms entre output e atualizacao visual
- NFR2: Animacoes a 60fps consistente
- NFR3: Sessoes 2h+ sem memory leaks
- NFR5: WebSocket estavel 2h+ com auto-reconnect

## Tasks / Subtasks

- [x] Task 1: WebSocket heartbeat and stability (AC: 2, 7)
  - [ ] Implement server-side heartbeat every 30s
  - [ ] Client responds to heartbeat, detects stale connection
  - [ ] Auto-reconnect within 5s on disconnect
  - [ ] Batch WebSocket updates: max 10/sec, queue overflow
- [x] Task 2: Phaser memory management (AC: 3)
  - [ ] Audit PipelineScene: destroy sprites/tweens on scene shutdown
  - [ ] NeoTrail: cap positions array, destroy trails on scene end
  - [ ] ParticleBurst: ensure all particles destroyed after tween
  - [ ] AmbientParticles: destroy on scene shutdown
  - [ ] Verify no orphaned game objects after full pipeline
- [x] Task 3: React cleanup (AC: 4)
  - [ ] Audit all useEffect hooks for proper cleanup
  - [ ] Ensure no state updates on unmounted components
  - [ ] Abort pending fetch requests on unmount
- [x] Task 4: Code rain optimization (AC: 5)
  - [ ] Cap MatrixRain to max 40 columns
  - [ ] Implement object pool for rain characters
  - [ ] Reuse canvas context efficiently
- [x] Task 5: Bundle and performance optimization (AC: 6, 8, 9)
  - [ ] Analyze bundle with `vite-bundle-visualizer`
  - [ ] Lazy load ArtifactEditor, VictoryScreen, SettingsPanel
  - [ ] Stream large artifacts instead of loading full content
  - [ ] Target: bundle < 500KB gzipped
  - [ ] Run Lighthouse audit: Performance > 85, Accessibility > 90
- [x] Task 6: Stability test (AC: 1, 10)
  - [ ] Run 3 consecutive mock pipelines
  - [ ] Monitor heap with Chrome DevTools: growth < 50MB over 2h
  - [ ] Verify no degradation in fps or responsiveness
  - [ ] Document results in QA Results section

## Dev Notes

### Architecture Reference
- MatrixRain at `frontend/src/components/MatrixRain.tsx`
- Phaser effects at `frontend/src/game/effects/`
- WebSocket hook at `frontend/src/hooks/useSocket.ts`

### Dependencies
- All Epic 3 stories (game engine to optimize)
- Story 4.7 (Error Handling) â€” reconnection banner

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 1.0 | Story created from PRD Epic 4 | River (SM) |

## QA Results
(to be filled by QA agent)
