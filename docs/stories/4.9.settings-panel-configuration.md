# Story 4.9: Settings Panel & Configuration

## Status
Ready for Review

## Executor Assignment
executor: "@dev"
quality_gate: "@qa"
quality_gate_tools: [lint, typecheck, manual-test]

## Story
**As a** user,
**I want** a settings panel to customize visual effects, approval points, and animation speeds,
**so that** I can tailor the experience to my preferences.

## Acceptance Criteria
1. `SettingsPanel.tsx` slide-in from right via gear icon
2. Visual Effects: toggles for Code Rain, Neo Trail, Glitch, Particles, master "Reduce Motion"
3. Pipeline: checkboxes for approval required per agent
4. Animation: sliders for Neo speed (50-300 px/s), typewriter speed (10-100 chars/s)
5. Persisted in localStorage
6. Loaded on mount, applied immediately
7. Reset to Defaults button
8. Matrix theme consistent
9. Changes apply without page reload
10. State in Zustand: `useSettingsStore.ts`

## Traceability
- FR30: Modo hibrido configurar etapas automaticas vs aprovacao
- FR8: Chuva de codigo com intensidade ajustavel

## Tasks / Subtasks

- [x] Task 1: Create useSettingsStore (AC: 5, 6, 10)
  - [x] Create `frontend/src/stores/useSettingsStore.ts`
  - [x] State: effects (codeRain, neoTrail, glitch, particles, reduceMotion), pipeline (approvalPerAgent map), animation (neoSpeed, typewriterSpeed)
  - [x] Persist to localStorage via Zustand middleware
  - [x] Load from localStorage on mount
  - [x] Default values matching current behavior
- [x] Task 2: Create SettingsPanel component (AC: 1, 8)
  - [x] Create `frontend/src/components/SettingsPanel.tsx`
  - [x] Gear icon button (fixed position, bottom-left or top-left)
  - [x] Slide-in panel from right
  - [x] Matrix theme: dark bg, green borders, monospace
  - [x] Close button (X) and click outside to close
- [x] Task 3: Visual effects toggles (AC: 2, 9)
  - [x] Toggle: Code Rain (on/off)
  - [x] Toggle: Neo Trail (on/off)
  - [x] Toggle: Glitch Effect (on/off)
  - [x] Toggle: Particles (on/off)
  - [x] Master toggle: Reduce Motion (disables trail, glitch, particles)
  - [x] Changes apply immediately without reload
- [x] Task 4: Pipeline approval config (AC: 3)
  - [x] Checkbox per agent: "Requer aprovacao"
  - [x] Display agent name + color indicator
  - [x] Send config to backend on change
- [x] Task 5: Animation sliders (AC: 4)
  - [x] Slider: Neo speed (50-300 px/s, default 150)
  - [x] Slider: Typewriter speed (10-100 chars/s, default 30)
  - [x] Live preview of values
- [x] Task 6: Reset to defaults (AC: 7)
  - [x] Reset to Defaults button
  - [x] Confirm dialog before reset
  - [x] Clear localStorage and reload settings
- [x] Task 7: Wire settings to consumers
  - [x] MatrixRain reads codeRain toggle
  - [x] PipelineScene reads neoSpeed, effect toggles
  - [x] MessageBubble reads typewriterSpeed
  - [x] Effects (NeoTrail, Glitch, Particles) read their toggles

## Dev Notes

### Architecture Reference
- Effects already have `setEnabled()` methods
- PipelineScene uses `NEO_SPEED` constant — make dynamic
- Pipeline config at `backend/config/pipeline.json`

### Dependencies
- Story 3.5 (Matrix Effects) — effects to toggle
- Story 3.4 (Neo Movement) — speed to configure
- Story 2.3 (Pipeline Orchestrator) — approval config

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 1.0 | Story created from PRD Epic 4 | River (SM) |

## File List
| File | Action |
|------|--------|
| `frontend/src/stores/useSettingsStore.ts` | Created — Zustand store with persist middleware |
| `frontend/src/components/SettingsPanel.tsx` | Created — Slide-in settings panel with toggles, sliders, checkboxes |
| `frontend/src/components/BottomBar.tsx` | Updated — Gear icon opens SettingsPanel |
| `frontend/src/components/MatrixRain.tsx` | Updated — Reads codeRain from useSettingsStore |
| `frontend/src/components/MessageBubble.tsx` | Updated — Reads typewriterSpeed from useSettingsStore |
| `frontend/src/game/PipelineScene.ts` | Updated — Reads neoSpeed and effect toggles from useSettingsStore |
| `frontend/src/hooks/useSocket.ts` | Updated — Sends pipeline approval config to backend on change |
| `frontend/src/styles/globals.css` | Updated — Added slide-in-right animation |
| `backend/src/routes/pipeline.ts` | Updated — Added update-pipeline-config socket handler |
| `backend/src/pipeline/orchestrator.ts` | Updated — Added updateApprovalConfig method |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
No issues encountered.

### Completion Notes
- Reused existing `useEffectsStore` pattern but created new `useSettingsStore` with `persist` middleware for localStorage
- SettingsPanel slides in from right via gear icon in BottomBar
- All effects (NeoTrail, GlitchEffect, AmbientParticles) are synced every frame via PipelineScene.update()
- Pipeline approval config sent to backend via socket on connect + on change
- Reset confirms before clearing settings

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 1.0 | Story created from PRD Epic 4 | River (SM) |
| 2026-02-27 | 1.1 | All tasks implemented | Dex (Dev) |

## QA Results
(to be filled by QA agent)
