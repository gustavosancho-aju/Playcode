# Story 5.4.1: QA Fixes — Interactive Content Pipeline

## Status
Done

## Executor Assignment
executor: "@dev"
quality_gate: "@qa"

## Story
**As a** desenvolvedor do Squad Playground,
**I want** corrigir todas as vulnerabilidades e issues identificados pela QA na Story 5.4,
**so that** o código esteja seguro, robusto e livre de bugs antes de seguir para a Wave 3.

## Origin
QA Review da Story 5.4 — Gate Decision: CONCERNS (2 CRITICAL, 2 HIGH, 7 MEDIUM, 5 LOW)

## Acceptance Criteria

### CRITICAL (Must Fix)
1. Todo conteúdo markdown interpolado em HTML deve ser sanitizado contra XSS
2. SessionId interpolado em HTML deve ser escapado contra XSS

### HIGH (Must Fix)
3. SessionId deve ser validado com regex em todas as rotas de artefatos
4. Variável morta `gameStore` removida do useSocket.ts

### MEDIUM (Should Fix)
5. Função `mdToHtml` extraída e reutilizada (sem duplicação)
6. `archive.on('error')` não deve usar throw em callback async
7. Line numbers do ArtifactEditor sincronizados com scroll do textarea
8. Keyboard shortcut 'E' no ApprovalPopup não deve disparar em inputs/textareas
9. Math.random() no VictoryScreen pré-calculado em generateParticles()
10. chunkCounts no useSocket limpo no evento pipeline-started
11. pipelineOrder derivado de AGENT_DEFINITIONS em vez de hardcoded

### LOW (Nice to Have)
12. URL de imagem usar req.get('host') em vez de localhost hardcoded
13. Catch sem variável não usada no ArtifactEditor
14. Hint "(Esc)" corrigido no ApprovalPopup
15. Fetch com AbortController no VictoryScreen

## Tasks / Subtasks

- [x] Task 1: Sanitização XSS no backend (AC: 1, 2, 3)
  - [x] Criar função `escapeHtml()` utilitária
  - [x] Sanitizar conteúdo em `/pdf` e `/proposta/preview`
  - [x] Escapar sessionId em templates HTML
  - [x] Validar sessionId com regex `/^[a-zA-Z0-9_-]+$/` em todas as rotas
- [x] Task 2: Extrair e consolidar mdToHtml (AC: 5)
  - [x] Unificar as duas versões em uma função reutilizável
  - [x] Aplicar escapeHtml antes das transformações markdown
- [x] Task 3: Fix archive error handler (AC: 6)
  - [x] Substituir throw por res.status(500)
- [x] Task 4: Fixes no frontend — useSocket (AC: 4, 10, 11)
  - [x] Remover variável morta gameStore
  - [x] Limpar chunkCounts no pipeline-started
  - [x] Derivar pipelineOrder de AGENT_DEFINITIONS
- [x] Task 5: Fixes no frontend — componentes (AC: 7, 8, 9, 12, 13, 14, 15)
  - [x] ArtifactEditor: sincronizar scroll line numbers
  - [x] ArtifactEditor: remover variável catch não usada
  - [x] ApprovalPopup: filtrar keyboard events em inputs
  - [x] ApprovalPopup: corrigir hint Esc
  - [x] VictoryScreen: pré-calcular cores das partículas
  - [x] VictoryScreen: AbortController no fetch
  - [x] Backend: URL dinâmica para imagens

## File List
- [ ] `backend/src/routes/artifacts.ts`
- [ ] `frontend/src/hooks/useSocket.ts`
- [ ] `frontend/src/components/ArtifactEditor.tsx`
- [ ] `frontend/src/components/ApprovalPopup.tsx`
- [ ] `frontend/src/components/VictoryScreen.tsx`

## Dependencies
- Story 5.4 (código base)
- QA Review Report
