import Phaser from 'phaser';

const PIXEL_SIZE = 2;
const SPRITE_W = 48;
const SPRITE_H = 48;
const RENDER_SIZE = SPRITE_W * PIXEL_SIZE; // 96px

// Minion Neo palette
const COLORS: Record<string, number> = {
  '1': 0x22c55e,  // green body/suit
  '2': 0x166534,  // dark green shading
  '3': 0xffffff,  // white (eye sclera, highlights)
  '4': 0x4ade80,  // glow green / visor glow
  '5': 0x1a1a2e,  // dark (cape, visor frame)
  '6': 0x333355,  // visor frame highlight
  '7': 0x0a0a0a,  // outline
  '8': 0xfde68a,  // skin (yellow-ish like Minion)
  '9': 0x111111,  // pupil / dark
  'A': 0x6ee7b7,  // metallic shine
  'B': 0x06b6d4,  // visor reflection cyan
  'C': 0x334155,  // boots/belt
  'D': 0x00FF41,  // neon matrix green (visor code)
  'E': 0x88572a,  // goggle strap brown
};

// =====================================================
// 48x48 MINION NEO — Pill-shaped body, big visor, stubby limbs
// Top: rounded head with goggles/visor
// Mid: green suit with "N" logo
// Bottom: stubby legs with boots
// =====================================================

// Idle 1 — standing, two normal eyes
const IDLE_1 = [
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000077777700000000000000000000000',
  '000000000000000007788888877000000000000000000000',
  '000000000000000078888888888700000000000000000000',
  '000000000000000788888888888870000000000000000000',
  '000000000000007888888888888887000000000000000000',
  '000000000000078888888888888887000000000000000000',
  '000000000000078888888888888887000000000000000000',
  '00000000000007EEEE5555555EEEE7000000000000000000',
  '0000000000000E5556633663355550E00000000000000000',
  '0000000000000E5563333633336550E00000000000000000',
  '0000000000000E5563393633936550E00000000000000000',
  '0000000000000E5563393633936550E00000000000000000',
  '0000000000000E5563333633336550E00000000000000000',
  '0000000000000E5556633663355550E00000000000000000',
  '0000000000000E5555566666555550E00000000000000000',
  '00000000000007EEEE5555555EEEE7000000000000000000',
  '000000000000078888888888888887000000000000000000',
  '000000000000007888888288888870000000000000000000',
  '000000000000000788888888887000000000000000000000',
  '000000000000000078888888870000000000000000000000',
  '000000000000000007777777700000000000000000000000',
  '000000000000000071111111170000000000000000000000',
  '000000000000000711111111117000000000000000000000',
  '000000000000007111141411111700000000000000000000',
  '000000000000071111144111111170000000000000000000',
  '000000000000071111111111111170000000000000000000',
  '000000000000071111111111111170000000000000000000',
  '000000000000007111111111111700000000000000000000',
  '00000000000000711C111111C1170000000000000000000',
  '000000000000000711111111170000000000000000000000',
  '000000000000000071111111700000000000000000000000',
  '000000000000000007222227000000000000000000000000',
  '000000000000000007222227000000000000000000000000',
  '000000000000000072200227000000000000000000000000',
  '00000000000000007C000C70000000000000000000000000',
  '00000000000000007C000C70000000000000000000000000',
  '000000000000000077000770000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
];

// Idle 2 — blink (eyes half-closed)
const IDLE_2 = [
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000077777700000000000000000000000',
  '000000000000000007788888877000000000000000000000',
  '000000000000000078888888888700000000000000000000',
  '000000000000000788888888888870000000000000000000',
  '000000000000007888888888888887000000000000000000',
  '000000000000078888888888888887000000000000000000',
  '000000000000078888888888888887000000000000000000',
  '00000000000007EEEE5555555EEEE7000000000000000000',
  '0000000000000E5555566666555550E00000000000000000',
  '0000000000000E5556666666665550E00000000000000000',
  '0000000000000E5556666666666550E00000000000000000',
  '0000000000000E5563396633936550E00000000000000000',
  '0000000000000E5563336633336550E00000000000000000',
  '0000000000000E5556636663655550E00000000000000000',
  '0000000000000E5555566666555550E00000000000000000',
  '00000000000007EEEE5555555EEEE7000000000000000000',
  '000000000000078888888888888887000000000000000000',
  '000000000000007888888288888870000000000000000000',
  '000000000000000788888888887000000000000000000000',
  '000000000000000078888888870000000000000000000000',
  '000000000000000007777777700000000000000000000000',
  '000000000000000071111111170000000000000000000000',
  '000000000000000711111111117000000000000000000000',
  '000000000000007111141411111700000000000000000000',
  '000000000000071111144111111170000000000000000000',
  '000000000000071111111111111170000000000000000000',
  '000000000000071111111111111170000000000000000000',
  '000000000000007111111111111700000000000000000000',
  '00000000000000711C111111C1170000000000000000000',
  '000000000000000711111111170000000000000000000000',
  '000000000000000071111111700000000000000000000000',
  '000000000000000007222227000000000000000000000000',
  '000000000000000007222227000000000000000000000000',
  '000000000000000072200227000000000000000000000000',
  '00000000000000007C000C70000000000000000000000000',
  '00000000000000007C000C70000000000000000000000000',
  '000000000000000077000770000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
];

// Idle 3 — same two eyes (static)
const IDLE_3 = [
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000077777700000000000000000000000',
  '000000000000000007788888877000000000000000000000',
  '000000000000000078888888888700000000000000000000',
  '000000000000000788888888888870000000000000000000',
  '000000000000007888888888888887000000000000000000',
  '000000000000078888888888888887000000000000000000',
  '000000000000078888888888888887000000000000000000',
  '00000000000007EEEE5555555EEEE7000000000000000000',
  '0000000000000E5556633663355550E00000000000000000',
  '0000000000000E5563333633336550E00000000000000000',
  '0000000000000E5563393633936550E00000000000000000',
  '0000000000000E5563393633936550E00000000000000000',
  '0000000000000E5563333633336550E00000000000000000',
  '0000000000000E5556633663355550E00000000000000000',
  '0000000000000E5555566666555550E00000000000000000',
  '00000000000007EEEE5555555EEEE7000000000000000000',
  '000000000000078888888888888887000000000000000000',
  '000000000000007888888288888870000000000000000000',
  '000000000000000788888888887000000000000000000000',
  '000000000000000078888888870000000000000000000000',
  '000000000000000007777777700000000000000000000000',
  '000000000000000071111111170000000000000000000000',
  '000000000000000711111111117000000000000000000000',
  '000000000000007111141411111700000000000000000000',
  '000000000000071111144111111170000000000000000000',
  '000000000000071111111111111170000000000000000000',
  '000000000000071111111111111170000000000000000000',
  '000000000000007111111111111700000000000000000000',
  '00000000000000711C111111C1170000000000000000000',
  '000000000000000711111111170000000000000000000000',
  '000000000000000071111111700000000000000000000000',
  '000000000000000007222227000000000000000000000000',
  '000000000000000007222227000000000000000000000000',
  '000000000000000072200227000000000000000000000000',
  '00000000000000007C000C70000000000000000000000000',
  '00000000000000007C000C70000000000000000000000000',
  '000000000000000077000770000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
];

// Walk 1 — left leg forward, right arm forward
const WALK_1 = [
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000077777700000000000000000000000',
  '000000000000000007788888877000000000000000000000',
  '000000000000000078888888888700000000000000000000',
  '000000000000000788888888888870000000000000000000',
  '000000000000007888888888888887000000000000000000',
  '000000000000078888888888888887000000000000000000',
  '000000000000078888888888888887000000000000000000',
  '00000000000007EEEE5555555EEEE7000000000000000000',
  '0000000000000E5555566666555550E00000000000000000',
  '0000000000000E5563333633336550E00000000000000000',
  '0000000000000E5563393633936550E00000000000000000',
  '0000000000000E5563393633936550E00000000000000000',
  '0000000000000E5563333633336550E00000000000000000',
  '0000000000000E5556633663355550E00000000000000000',
  '0000000000000E5555566666555550E00000000000000000',
  '00000000000007EEEE5555555EEEE7000000000000000000',
  '000000000000078888888888888887000000000000000000',
  '000000000000007888888288888870000000000000000000',
  '000000000000000788888888887000000000000000000000',
  '000000000000000078888888870000000000000000000000',
  '000000000000000007777777700000000000000000000000',
  '000000000000000071111111170000000000000000000000',
  '00000000000008071111111117080000000000000000000',
  '000000000000880711141411110880000000000000000000',
  '000000000008807111144111117088000000000000000000',
  '000000000000007111111111111700000000000000000000',
  '000000000000007111111111111700000000000000000000',
  '000000000000007111111111111700000000000000000000',
  '00000000000000711C111111C1170000000000000000000',
  '000000000000000711111111170000000000000000000000',
  '000000000000000071111111700000000000000000000000',
  '000000000000000007222227000000000000000000000000',
  '000000000000000072222227000000000000000000000000',
  '000000000000000720002270000000000000000000000000',
  '0000000000000007C0000C7000000000000000000000000',
  '000000000000007C00000077000000000000000000000000',
  '000000000000000000000770000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
];

// Walk 2 — mid stride (neutral)
const WALK_2 = [
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000077777700000000000000000000000',
  '000000000000000007788888877000000000000000000000',
  '000000000000000078888888888700000000000000000000',
  '000000000000000788888888888870000000000000000000',
  '000000000000007888888888888887000000000000000000',
  '000000000000078888888888888887000000000000000000',
  '000000000000078888888888888887000000000000000000',
  '00000000000007EEEE5555555EEEE7000000000000000000',
  '0000000000000E5555566666555550E00000000000000000',
  '0000000000000E5563333633336550E00000000000000000',
  '0000000000000E5563393633936550E00000000000000000',
  '0000000000000E5563393633936550E00000000000000000',
  '0000000000000E5563333633336550E00000000000000000',
  '0000000000000E5556633663355550E00000000000000000',
  '0000000000000E5555566666555550E00000000000000000',
  '00000000000007EEEE5555555EEEE7000000000000000000',
  '000000000000078888888888888887000000000000000000',
  '000000000000007888888288888870000000000000000000',
  '000000000000000788888888887000000000000000000000',
  '000000000000000078888888870000000000000000000000',
  '000000000000000007777777700000000000000000000000',
  '000000000000000071111111170000000000000000000000',
  '000000000000000711111111117000000000000000000000',
  '000000000000007111141411111700000000000000000000',
  '000000000000071111144111111170000000000000000000',
  '000000000000071111111111111170000000000000000000',
  '000000000000071111111111111170000000000000000000',
  '000000000000007111111111111700000000000000000000',
  '00000000000000711C111111C1170000000000000000000',
  '000000000000000711111111170000000000000000000000',
  '000000000000000071111111700000000000000000000000',
  '000000000000000007222227000000000000000000000000',
  '000000000000000007222227000000000000000000000000',
  '000000000000000072200227000000000000000000000000',
  '00000000000000007C000C70000000000000000000000000',
  '00000000000000007C000C70000000000000000000000000',
  '000000000000000077000770000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
];

// Walk 3 — right leg forward, left arm forward
const WALK_3 = [
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000077777700000000000000000000000',
  '000000000000000007788888877000000000000000000000',
  '000000000000000078888888888700000000000000000000',
  '000000000000000788888888888870000000000000000000',
  '000000000000007888888888888887000000000000000000',
  '000000000000078888888888888887000000000000000000',
  '000000000000078888888888888887000000000000000000',
  '00000000000007EEEE5555555EEEE7000000000000000000',
  '0000000000000E5555566666555550E00000000000000000',
  '0000000000000E5563333633336550E00000000000000000',
  '0000000000000E5563393633936550E00000000000000000',
  '0000000000000E5563393633936550E00000000000000000',
  '0000000000000E5563333633336550E00000000000000000',
  '0000000000000E5556633663355550E00000000000000000',
  '0000000000000E5555566666555550E00000000000000000',
  '00000000000007EEEE5555555EEEE7000000000000000000',
  '000000000000078888888888888887000000000000000000',
  '000000000000007888888288888870000000000000000000',
  '000000000000000788888888887000000000000000000000',
  '000000000000000078888888870000000000000000000000',
  '000000000000000007777777700000000000000000000000',
  '000000000000000071111111170000000000000000000000',
  '00000000000008071111111117080000000000000000000',
  '000000000000880711141411110880000000000000000000',
  '000000000008807111144111117088000000000000000000',
  '000000000000007111111111111700000000000000000000',
  '000000000000007111111111111700000000000000000000',
  '000000000000007111111111111700000000000000000000',
  '00000000000000711C111111C1170000000000000000000',
  '000000000000000711111111170000000000000000000000',
  '000000000000000071111111700000000000000000000000',
  '000000000000000007222227000000000000000000000000',
  '000000000000000007222227000000000000000000000000',
  '000000000000000072200227000000000000000000000000',
  '00000000000000007C000C70000000000000000000000000',
  '000000000000007700000C7000000000000000000000000',
  '000000000000007700000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
];

// Walk 4 — reuse mid stride
const WALK_4 = WALK_2;

// Processing 1 — visor shows matrix code (4/D replace eye area), body vibrates (outline=4)
const PROCESS_1 = [
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000044444400000000000000000000000',
  '000000000000000004488888844000000000000000000000',
  '000000000000000048888888888400000000000000000000',
  '000000000000000488888888888840000000000000000000',
  '000000000000004888888888888884000000000000000000',
  '000000000000048888888888888884000000000000000000',
  '000000000000048888888888888884000000000000000000',
  '00000000000004EEEE5555555EEEE4000000000000000000',
  '0000000000000E555DD4DD4D555550E00000000000000000',
  '0000000000000E55D4D4DD4DD5550E00000000000000000',
  '0000000000000E554DDD4D4DDD550E00000000000000000',
  '0000000000000E55DD4DDD4D4D550E00000000000000000',
  '0000000000000E554D4D4DDD4D550E00000000000000000',
  '0000000000000E55DDD4DD4DDD550E00000000000000000',
  '0000000000000E555DD4DD4D555550E00000000000000000',
  '00000000000004EEEE5555555EEEE4000000000000000000',
  '000000000000048888888888888884000000000000000000',
  '000000000000004888888288888840000000000000000000',
  '000000000000000488888888884000000000000000000000',
  '000000000000000048888888840000000000000000000000',
  '000000000000000004444444400000000000000000000000',
  '000000000000000041111111140000000000000000000000',
  '000000000000000411111111114000000000000000000000',
  '000000000000004111141411111400000000000000000000',
  '000000000000041111144111111140000000000000000000',
  '000000000000041111111111111140000000000000000000',
  '000000000000041111111111111140000000000000000000',
  '000000000000004111111111111400000000000000000000',
  '00000000000000411C111111C1140000000000000000000',
  '000000000000000411111111140000000000000000000000',
  '000000000000000041111111400000000000000000000000',
  '000000000000000004222224000000000000000000000000',
  '000000000000000004222224000000000000000000000000',
  '000000000000000042200224000000000000000000000000',
  '00000000000000004C000C40000000000000000000000000',
  '00000000000000004C000C40000000000000000000000000',
  '000000000000000044000440000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
];

// Processing 2 — different matrix code pattern, metallic shimmer
const PROCESS_2 = [
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '00000000000000000A0AAAAA0A000000000000000000000',
  '0000000000000000AA88888888AA00000000000000000000',
  '00000000000000A088888888880A00000000000000000000',
  '0000000000000A0888888888888A0000000000000000000',
  '000000000000A08888888888888A8000000000000000000',
  '00000000000A0888888888888888A000000000000000000',
  '00000000000A0888888888888888A000000000000000000',
  '00000000000004EEEE5555555EEEE4000000000000000000',
  '0000000000000E5554D4D4DD555550E00000000000000000',
  '0000000000000E554DD4D44DD5550E00000000000000000',
  '0000000000000E55D4D4DD4D4D550E00000000000000000',
  '0000000000000E554DD4D4DD4D550E00000000000000000',
  '0000000000000E55D44D4D4D4D550E00000000000000000',
  '0000000000000E554D4DD44DD5550E00000000000000000',
  '0000000000000E5554D4D4DD555550E00000000000000000',
  '00000000000004EEEE5555555EEEE4000000000000000000',
  '000000000000048888888888888884000000000000000000',
  '000000000000004888888288888840000000000000000000',
  '000000000000000488888888884000000000000000000000',
  '000000000000000048888888840000000000000000000000',
  '000000000000000004444444400000000000000000000000',
  '000000000000000041111111140000000000000000000000',
  '000000000000000411111111114000000000000000000000',
  '000000000000004111141411111400000000000000000000',
  '000000000000041111144111111140000000000000000000',
  '000000000000041111111111111140000000000000000000',
  '000000000000041111111111111140000000000000000000',
  '000000000000004111111111111400000000000000000000',
  '00000000000000411C111111C1140000000000000000000',
  '000000000000000411111111140000000000000000000000',
  '000000000000000041111111400000000000000000000000',
  '000000000000000004222224000000000000000000000000',
  '000000000000000004222224000000000000000000000000',
  '000000000000000042200224000000000000000000000000',
  '00000000000000004C000C40000000000000000000000000',
  '00000000000000004C000C40000000000000000000000000',
  '000000000000000044000440000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
];

// Success 1 — arms up, happy eye (3=smile in mouth area)
const SUCCESS_1 = [
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000077777700000000000000000000000',
  '000000000000000007788888877000000000000000000000',
  '000000000000000078888888888700000000000000000000',
  '000000000000000788888888888870000000000000000000',
  '000000000000007888888888888887000000000000000000',
  '000000000000078888888888888887000000000000000000',
  '000000000000078888888888888887000000000000000000',
  '00000000000007EEEE5555555EEEE7000000000000000000',
  '0000000000000E5555566666555550E00000000000000000',
  '0000000000000E5563333633336550E00000000000000000',
  '0000000000000E5563393633936550E00000000000000000',
  '0000000000000E5563393633936550E00000000000000000',
  '0000000000000E5563333633336550E00000000000000000',
  '0000000000000E5556633663355550E00000000000000000',
  '0000000000000E5555566666555550E00000000000000000',
  '00000000000007EEEE5555555EEEE7000000000000000000',
  '000000000000078888888888888887000000000000000000',
  '000000000000007888838838888870000000000000000000',
  '000000000000000788883388887000000000000000000000',
  '000000000000000078888888870000000000000000000000',
  '000000000000000007777777700000000000000000000000',
  '000000000000800071111111170008000000000000000000',
  '000000000008800711111111117008800000000000000000',
  '000000000088007111141411111700880000000000000000',
  '000000000880071111144111111170088000000000000000',
  '000000000800071111111111111700080000000000000000',
  '000000000000071111111111111170000000000000000000',
  '000000000000007111111111111700000000000000000000',
  '00000000000000711C111111C1170000000000000000000',
  '000000000000000711111111170000000000000000000000',
  '000000000000000071111111700000000000000000000000',
  '000000000000000007222227000000000000000000000000',
  '000000000000000007222227000000000000000000000000',
  '000000000000000072200227000000000000000000000000',
  '00000000000000007C000C70000000000000000000000000',
  '00000000000000007C000C70000000000000000000000000',
  '000000000000000077000770000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
];

const SUCCESS_2 = SUCCESS_1;

// Enter 1 — materializing pixel by pixel (scattered with gaps)
const ENTER_1 = [
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000040404000000000000000000000000',
  '000000000000000004040808040000000000000000000000',
  '000000000000000040808080804000000000000000000000',
  '000000000000000408080808080400000000000000000000',
  '000000000000004080808080808040000000000000000000',
  '000000000000040808080808080804000000000000000000',
  '000000000000040808080808080804000000000000000000',
  '00000000000004E0E04050505E0E04000000000000000000',
  '0000000000000E0505040604050500E00000000000000000',
  '0000000000000E0504030303040500E00000000000000000',
  '0000000000000E0503030903030500E00000000000000000',
  '0000000000000E0503039903030500E00000000000000000',
  '0000000000000E0503030903030500E00000000000000000',
  '0000000000000E0504030303040500E00000000000000000',
  '0000000000000E0505040604050500E00000000000000000',
  '00000000000004E0E04050505E0E04000000000000000000',
  '000000000000040808080808080804000000000000000000',
  '000000000000004080808020808040000000000000000000',
  '000000000000000408080808080400000000000000000000',
  '000000000000000040808080804000000000000000000000',
  '000000000000000004040404400000000000000000000000',
  '000000000000000040101010140000000000000000000000',
  '000000000000000401010101014000000000000000000000',
  '000000000000004010104010101400000000000000000000',
  '000000000000040101040101010140000000000000000000',
  '000000000000040101010101010140000000000000000000',
  '000000000000040101010101010140000000000000000000',
  '000000000000004010101010101400000000000000000000',
  '00000000000000401C010101C0140000000000000000000',
  '000000000000000401010101040000000000000000000000',
  '000000000000000040101010400000000000000000000000',
  '000000000000000004020204000000000000000000000000',
  '000000000000000004020204000000000000000000000000',
  '000000000000000040200204000000000000000000000000',
  '00000000000000004C000C40000000000000000000000000',
  '00000000000000004C000C40000000000000000000000000',
  '000000000000000044000440000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
  '000000000000000000000000000000000000000000000000',
];

const ENTER_2 = IDLE_1;

type AnimationKey = 'idle' | 'walk' | 'processing' | 'enter' | 'exit' | 'success';

const FRAME_MAP: Record<string, string[][]> = {
  idle: [IDLE_1, IDLE_2, IDLE_3],
  walk: [WALK_1, WALK_2, WALK_3, WALK_4],
  processing: [PROCESS_1, PROCESS_2],
  success: [SUCCESS_1, SUCCESS_2],
  enter: [ENTER_1, ENTER_2],
};

// Glassmorphism capsule radius
const CAPSULE_RADIUS = 52;

export class NeoCharacter {
  private scene: Phaser.Scene;
  private container!: Phaser.GameObjects.Container;
  private graphics!: Phaser.GameObjects.Graphics;
  private capsuleGraphics!: Phaser.GameObjects.Graphics;
  private glowGraphics!: Phaser.GameObjects.Graphics;
  private reflectionGraphics!: Phaser.GameObjects.Graphics;
  public x: number;
  public y: number;
  private currentAnim: AnimationKey = 'idle';
  private frameIndex = 0;
  private frameTimer = 0;
  private frameRates: Record<string, number> = {
    idle: 500,
    walk: 150,
    processing: 300,
    success: 400,
    enter: 250,
  };
  private pulseAlpha = 1;
  private pulseDir = -1;
  private glowPhase = 0;
  private reflectionAngle = 0;
  private statusText!: Phaser.GameObjects.Text;
  private statusBlinkPhase = 0;
  private pipelineActive = false;

  constructor(scene: Phaser.Scene, x: number, y: number) {
    this.scene = scene;
    this.x = x;
    this.y = y;
  }

  static preload(_scene: Phaser.Scene): void {
    // Procedural pixel art — no external assets
  }

  create(): void {
    this.glowGraphics = this.scene.add.graphics();
    this.capsuleGraphics = this.scene.add.graphics();
    this.graphics = this.scene.add.graphics();
    this.reflectionGraphics = this.scene.add.graphics();
    this.statusText = this.scene.add.text(CAPSULE_RADIUS * 0.4, -CAPSULE_RADIUS - 14, 'z z z', {
      fontFamily: '"Geist", system-ui, sans-serif',
      fontSize: '14px',
      fontStyle: 'bold',
      color: '#4ade80',
      shadow: { offsetX: 0, offsetY: 0, color: '#00FF41', blur: 8, fill: true, stroke: false },
    });
    this.container = this.scene.add.container(this.x, this.y, [
      this.glowGraphics,
      this.capsuleGraphics,
      this.graphics,
      this.reflectionGraphics,
      this.statusText,
    ]);
    this.drawCapsule();
    this.drawFrame();
  }

  setPipelineActive(active: boolean): void {
    this.pipelineActive = active;
  }

  /** Glassmorphism circular capsule with gradient reflective border */
  private drawCapsule(): void {
    const g = this.capsuleGraphics;
    g.clear();
    const r = CAPSULE_RADIUS;

    // Outer neon glow (box-shadow equivalent)
    g.fillStyle(0x00FF41, 0.04);
    g.fillCircle(0, 0, r + 12);
    g.fillStyle(0x00FF41, 0.06);
    g.fillCircle(0, 0, r + 6);

    // Glass fill — translucent dark with slight green tint
    g.fillStyle(0x00FF41, 0.04);
    g.fillCircle(0, 0, r);

    // Gradient border — alternating bright/dark green segments
    const segments = 32;
    for (let i = 0; i < segments; i++) {
      const angle = (i / segments) * Math.PI * 2;
      const nextAngle = ((i + 1) / segments) * Math.PI * 2;
      const lightFactor = (Math.cos(angle - Math.PI * 0.75) + 1) / 2;
      const brightness = 0.08 + lightFactor * 0.35;
      const isHighlight = i % 2 === 0;
      const color = isHighlight ? 0x6ee7b7 : 0x166534;

      g.lineStyle(2, color, brightness);
      g.beginPath();
      g.arc(0, 0, r, angle, nextAngle, false);
      g.strokePath();
    }

    // Inner edge — glass depth
    g.lineStyle(1, 0x4ade80, 0.08);
    g.strokeCircle(0, 0, r - 2);
  }

  /** Dynamic light reflection orbiting inside capsule */
  private drawReflection(): void {
    const rg = this.reflectionGraphics;
    rg.clear();

    const r = CAPSULE_RADIUS;
    const rx = Math.cos(this.reflectionAngle) * (r * 0.5);
    const ry = Math.sin(this.reflectionAngle) * (r * 0.5) - 10;

    rg.fillStyle(0xffffff, 0.06);
    rg.fillCircle(rx, ry, 18);
    rg.fillStyle(0xffffff, 0.03);
    rg.fillCircle(rx, ry, 28);

    // Fixed specular highlight top-left
    rg.fillStyle(0xffffff, 0.1);
    rg.fillCircle(-r * 0.35, -r * 0.4, 6);
    rg.fillStyle(0xffffff, 0.05);
    rg.fillCircle(-r * 0.35, -r * 0.4, 10);
  }

  private drawFrame(): void {
    let frames = FRAME_MAP[this.currentAnim] || FRAME_MAP['idle'];
    // Sleeping: use only closed-eye frame; Active: use only open-eye frames
    if (this.currentAnim === 'idle') {
      frames = this.pipelineActive ? [IDLE_1, IDLE_3] : [IDLE_2];
    }
    const frame = frames[this.frameIndex % frames.length];
    const g = this.graphics;
    g.clear();

    const offsetX = -(RENDER_SIZE / 2);
    const offsetY = -(RENDER_SIZE / 2);

    for (let row = 0; row < SPRITE_H; row++) {
      for (let col = 0; col < SPRITE_W; col++) {
        const ch = frame[row]?.[col];
        if (ch && ch !== '0') {
          const color = COLORS[ch] || COLORS['1'];
          let alpha = this.currentAnim === 'processing' ? this.pulseAlpha : 1;
          if (ch === '4' || ch === 'A' || ch === 'D') alpha = Math.min(1, this.pulseAlpha + 0.2);
          g.fillStyle(color, alpha);
          g.fillRect(
            offsetX + col * PIXEL_SIZE,
            offsetY + row * PIXEL_SIZE,
            PIXEL_SIZE,
            PIXEL_SIZE
          );
        }
      }
    }
  }

  private drawGlowAura(): void {
    const gg = this.glowGraphics;
    gg.clear();

    // Always-on subtle neon glow
    const baseAlpha = 0.03 + Math.sin(this.glowPhase * 0.7) * 0.015;
    gg.fillStyle(0x00FF41, baseAlpha);
    gg.fillCircle(0, 0, CAPSULE_RADIUS + 20);

    const isActive = this.currentAnim === 'processing' || this.currentAnim === 'success';
    if (isActive) {
      const alpha = 0.06 + Math.sin(this.glowPhase) * 0.04;
      gg.fillStyle(0x00FF41, alpha);
      gg.fillCircle(0, 0, CAPSULE_RADIUS + 14);
      gg.fillStyle(0x4ade80, alpha * 0.6);
      gg.fillCircle(0, 0, CAPSULE_RADIUS + 24);
    }
  }

  play(animation: string): void {
    const anim = animation as AnimationKey;
    const mapped = FRAME_MAP[anim] ? anim : 'idle';
    if (mapped !== this.currentAnim) {
      this.currentAnim = mapped as AnimationKey;
      this.frameIndex = 0;
      this.frameTimer = 0;
      this.drawFrame();
    }
  }

  setDirection(_dir: 'down' | 'up' | 'right' | 'left'): void {
    // Capsule stays upright — no rotation
  }

  setPosition(x: number, y: number): void {
    this.x = x;
    this.y = y;
    this.container?.setPosition(x, y);
  }

  setFlipX(_flip: boolean): void {
    // Not needed for capsule design
  }

  setAlpha(alpha: number): void {
    this.container?.setAlpha(alpha);
  }

  setVisible(visible: boolean): void {
    this.container?.setVisible(visible);
  }

  getDisplayObject(): Phaser.GameObjects.GameObject | null {
    return this.container || null;
  }

  update(delta: number): void {
    this.frameTimer += delta;
    this.glowPhase += delta * 0.004;
    this.reflectionAngle += delta * 0.0008;
    const rate = this.frameRates[this.currentAnim] || 500;

    if (this.currentAnim === 'processing') {
      this.pulseAlpha += this.pulseDir * (delta / 400);
      if (this.pulseAlpha <= 0.4) { this.pulseAlpha = 0.4; this.pulseDir = 1; }
      if (this.pulseAlpha >= 1) { this.pulseAlpha = 1; this.pulseDir = -1; }
    }

    this.drawGlowAura();
    this.drawReflection();
    this.updateStatusIndicator(delta);

    if (this.frameTimer >= rate) {
      this.frameTimer = 0;
      let frames = FRAME_MAP[this.currentAnim] || FRAME_MAP['idle'];
      if (this.currentAnim === 'idle') {
        frames = this.pipelineActive ? [IDLE_1, IDLE_3] : [IDLE_2];
      }
      this.frameIndex = (this.frameIndex + 1) % frames.length;
      this.drawFrame();
    }
  }

  private updateStatusIndicator(delta: number): void {
    this.statusBlinkPhase += delta * 0.004;
    const blinkAlpha = 0.4 + Math.sin(this.statusBlinkPhase * 2) * 0.6;

    if (this.pipelineActive) {
      this.statusText.setText('!');
      this.statusText.setColor('#00FF41');
      this.statusText.setFontSize(18);
      this.statusText.setAlpha(Math.max(0.6, blinkAlpha));
    } else {
      // Sleeping — "z z z" floating and pulsing
      this.statusText.setText('z z z');
      this.statusText.setColor('#4ade80');
      this.statusText.setFontSize(14);
      this.statusText.setAlpha(Math.max(0.2, blinkAlpha * 0.7));
      // Gentle float up/down
      const floatY = -CAPSULE_RADIUS - 14 + Math.sin(this.statusBlinkPhase) * 4;
      this.statusText.setY(floatY);
    }
  }

  destroy(): void {
    this.container?.destroy();
  }
}
